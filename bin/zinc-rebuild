#!/usr/bin/env bash
#
# USAGE:
#   zinc-rebuild [-?|--debug] [-h|--help] [PATH]
#
# OPTIONS:
#   -?, --debug   -- Enables debug (verbose) mode.
#   -h, --help    -- Displays this help message.
#

# Get the script directory.
DIRECTORY="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source the 'trace' functions.
source "${DIRECTORY}/trace"

# Set the debug mode flag.
DEBUG="${MX_DEBUG:-0}"

# Parse the command line options.
while [[ $# -gt 0 ]]; do
  case "$1" in
    -\?|--debug)
      DEBUG=1
      shift
      ;;
    -h|--help)
      sed -n '2,/^$/s/^# \?//p' "$0"
      exit 0
      ;;
    *)
      break
      ;;
  esac
done

# Assert that we have at most one argument.
if [[ $# -gt 1 ]]; then
  error "Too many arguments, exiting process..."
  exit 1
fi

# Get the flake path.
FLAKE="${1:-.}"

# Assert that the directory exists.
if [[ ! -d "$FLAKE" ]]; then
  error "Path '$FLAKE' does not exist, exiting process..."
  exit 1
fi

# Assert that the directory contains a 'flake.nix'.
if [[ ! -f "$FLAKE/flake.nix" ]]; then
  error "'flake.nix' not found in directory '$FLAKE', exiting process..."
  exit 1
fi

# Get the system hostname.
HOSTNAME="$(hostname)"

# Build the 'nixos-rebuild' command.
COMMAND="sudo nixos-rebuild switch --flake ${FLAKE}#${HOSTNAME}"

if [[ "$DEBUG" -eq 1 ]]; then
  debug "Rebuilding '$HOSTNAME' from path '$FLAKE'"
  debug "Executing command '$COMMAND'"
fi

# Execute the command.
exec $COMMAND
