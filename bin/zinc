#!/usr/bin/env bash
#
# USAGE:
#   zinc [-?|--debug] [-h|--help] COMMAND [ARGS...]
#
# OPTIONS:
#   -?, --debug   -- Enables debug (verbose) mode.
#   -h, --help    -- Displays this help message.
#
# COMMANDS:
#   - flake [name]       -- Enter a remote development environment.
#   - rebuild [path]     -- Apply changes made to the NixOS configuration.
#   

# Get the script directory.
DIRECTORY="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source the 'trace' functions.
source "${DIRECTORY}/trace"

# Set the debug mode flag.
DEBUG=0

# Parse the command line options.
while [[ $# -gt 0 ]]; do
  case "$1" in
    -\?|--debug)
      DEBUG=1
      shift
      ;;
    -h|--help)
      sed -n '2,/^$/s/^# \?//p' "$0"
      exit 0
      ;;
    *)
      break
      ;;
  esac
done

# Assert that we have at least one subcommand.
if [[ $# -eq 0 ]]; then
  error "No command specified, exiting process..."
  exit 1
fi

# Get the specified command.
COMMAND="$1"
shift

# Build the corresponding sub-script path.
SCRIPT="${DIRECTORY}/zinc-${COMMAND}"

# Assert that the script exists.
if [[ ! -x "$SCRIPT" ]]; then
  error "Command '$COMMAND' not found, exiting process..."
  exit 1
fi

# Export the debug flag for sub-processes.
export MX_DEBUG="$DEBUG"

# Execute the script.
exec "$SCRIPT" "$@"
