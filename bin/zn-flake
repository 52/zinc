#!/usr/bin/env bash
#
# USAGE:
#   zn-flake [-?|--debug] [-h|--help] NAME
#
# OPTIONS:
#   -?, --debug   -- Enables debug (verbose) mode.
#   -h, --help    -- Displays this help message.
#

# Get the script directory.
DIRECTORY="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source the 'trace' functions.
source "${DIRECTORY}/trace"

# Set the debug mode flag.
DEBUG="${MX_DEBUG:-0}"

# Parse the command line options.
while [[ $# -gt 0 ]]; do
  case "$1" in
    -\?|--debug)
      DEBUG=1
      shift
      ;;
    -h|--help)
      sed -n '2,/^$/s/^# \?//p' "$0"
      exit 0
      ;;
    *)
      break
      ;;
  esac
done

# Assert that a flake name was specified.
if [[ $# -eq 0 ]]; then
  error "No flake name specified, exiting process..."
  exit 1
fi

# Assert that we have exactly one argument.
if [[ $# -ne 1 ]]; then
  error "Too many arguments, exiting process..."
  exit 1
fi

# Get the flake name.
FLAKE="$1"

# Build the remote flake url.
FLAKE_URL="github:52/nix-flakes?dir=${FLAKE}"

# Build the 'nix develop' command.
COMMAND="nix develop ${FLAKE_URL} --refresh --no-write-lock-file --impure -c ${SHELL:-bash}"

if [[ "$DEBUG" -eq 1 ]]; then
  debug "Entering '$FLAKE' from '$FLAKE_URL'"
  debug "Executing command '$COMMAND'"
fi

# Enter the development environment.
exec $COMMAND
